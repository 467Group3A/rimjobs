<!doctype html>
<html lang="en">

<head>
  <title>Rim Jobs</title>
  <link rel="icon" type="image/x-icon" href="/img/favicon.ico">
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS v5.2.1 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <!-- FontAwesome 6.2.0 CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
    crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <!-- Rim Jobs CSS -->
  <link rel="stylesheet" href="/css/stylesheet.css">
</head>

<body>
  <header id="navbar"></header>
  <main>
    <div id="app">
      <h1>Order Details</h1>
      <div v-if="selectedOrder">
        <p>Order ID: {{ selectedOrder.orderId }}</p>
        <div v-if="!hideForPrint">
          <p>Order Status: {{ selectedOrder.order.status }}</p>
        </div>
        <p>Order Date: {{ selectedOrder.order.date }}</p>
        <p>Weight: {{ selectedOrder.order.weight }}lbs</p>
        <p>Part cost: ${{ selectedOrder.order.amount }}</p>
        <p>Shipping cost: ${{ selectedOrder.order.shipping }}</p>
        <p>Total cost: ${{selectedOrder.order.amount + selectedOrder.order.shipping}}</p>
        <h2>Customer Information:</h2>
        <p>Name: {{ selectedOrder.order.name}}</p>
        <p>Email: {{ selectedOrder.order.email}}</p>
        <p>Address: {{ selectedOrder.order.address }}</p>
        <h2>Items in the order</h2>
        <thead>
          <th>Part Number -</th>
          <th># of part -</th>
        </thead>
        <ul>
          <li v-for="orderItem in selectedOrder.orderItems" :key="orderItem.id">
            {{ orderItem.partnumber}} / {{ orderItem.quantity }}
          </li>
          </ul>
          <div v-if="!hideForPrint">
            <label for="select-option">Order status:</label>
            <select v-model="selectedOption" id="select-option">
            <option v-for="option in options" :key="option.value" :value="option.value">{{ option.label }}</option>
            </select>
            <button @click="updateOrder" :disabled="!selectedOption">Update</button>
            <div v-if="selectedOrder.order.status == 'Filled'">
              <button @click="printPage">Print Invoice</button>
            </div>
          </div>
        </div>
    </div>
  </main>
  <footer>
    <!-- place footer here -->
  </footer>
  <!-- Bootstrap JavaScript Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <!-- JQuery -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js" integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
  <!-- Vue.js -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- Components -->
  <script src="/fetchNavbar.js"></script>

  <script>
    const app = Vue.createApp({
    data() {
      return {
        options: [
            { label: 'In Progress', value: 'In Progress' },
            { label: 'Filled', value: 'Filled' },
            { label: 'Canceled', value: 'Canceled' }
        ],
        selectedOption: null,
        selectedOrder: null,
        hideForPrint: false,
        message: ''
      };
    },
    methods: {
      async getOrderDetails(orderId) {
      try {
        const response = await fetch(`/api/orderdetails/${orderId}`);
        const orderDetails = await response.json();
        this.selectedOrder = orderDetails;
      } catch (error) {
        console.log(error);
      }
    },
    updateOrder() {
      const body = {
        orderId: this.selectedOrder.orderId,
        orderStatus: this.selectedOption
      }
      fetch('/api/updateorder', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      })
      .then(response => {
        if(response.status == '200'){
        this.message = "Updated order status successfully!"
        } else if (response.status == '500') {
          this.message = "Unable to update order status!"
        }
      })
      // Force refresh page
      location.reload()
    },
    printPage(){
      
      this.hideForPrint = true;

      // wait for 500ms (half a second)
      setTimeout(() => {
      // print the page
      window.print();

      // set hideForPrint back to false
      this.hideForPrint = false;
      }, 500);
    }
  },
    mounted() {
      const searchParams = new URLSearchParams(window.location.search);
      const orderId = searchParams.get('id');
      this.getOrderDetails(orderId)
    }
  }).mount('#app');

  </script>
</body>
</html>